<!doctype html>
<html>
<!--
 * KanTanMarkdown v1.20160214.02
 * Copyright (c) 2016 tatesuke
 * Released under the MIT license
 * http://opensource.org/licenses/mit-license.php
 --><head>
<meta charset="utf-8">
<style>
body {
	margin: 0;
	padding: 0;
}

.onDragover {
	border : 5px dashed #99cde1;
}

nav {
	margint:0;
	text-align : right;
}

#attach {
	width:100%;
	border-top:1px solid gray;
	border-bottom:1px solid gray;
	display:none;
}
#attachForm {
	box-sizing:border-box;
	width:100%;
	height:100%;
	display:none;
}

input[type="file"] {
	width:100%;
}

#filer{
	box-sizing:border-box;
	width:100%;
	height:150px;
	overflow: auto;
	display:none;
}

#attachToggleButton,
#previewToggleButton{
	width: 50%;
}

#wrapper {
	overflow: auto;
}

#editor {
	box-sizing:border-box;
	resize:none; 
	width:50%;
	height:100%;
	float:left;
	border-top:none;
	display:none;
	-moz-tab-size: 4;
	-o-tab-size: 4;
	tab-size: 4;
	border:1px solid gray;
	margin: 0;
}

#previewer {
	box-sizing:border-box;
	width:100%;
	margin: 0 auto;
	overflow:auto;
	word-wrap: break-word;
	border:1px solid gray;
}

#previewer:empty {
	border: 0;
}

#previewer:after {
	content: "."; 
	display: block; 
	height: 0; 
	font-size:0;	
	clear: both; 
	visibility:hidden;
}

.info{
	color : #3a87ad;
	background-color: #d9edf7;
	border: 1px solid #bce8f1;
	font-size: 13px;
	line-height: 19px;
	padding: 6px 10px;
	border-radius: 0px;
	margin: 1em 0px 1em;
}

.warn{
	color : #c09853;
	background-color: #fcf8e3;
	border: 1px solid #fbeed5;
	font-size: 13px;
	line-height: 19px;
	padding: 6px 10px;
	border-radius: 0px;
	margin: 1em 0px 1em;
}

.alert{
	color : #b94a48;
	background-color: #f2dede;
	border: 1px solid #eed3d7;
	font-size: 13px;
	line-height: 19px;
	padding: 6px 10px;
	border-radius: 0px;
	margin: 1em 0px 1em;
}

@media print{
	nav {
		display:none;
	}

	#wrapper {
		overflow: visible;
	}
	
	#previewer {
		border: 0;
	}
}
</style>

<style>
#previewer {
  font-family: Helvetica, arial, sans-serif;
  font-size: 14px;
  line-height: 1.6;
  padding-top: 10px;
  padding-bottom: 10px;
  background-color: white;
  padding: 45px; }
#previewer > *:first-child {
  margin-top: 0 !important; }
#previewer > *:last-child {
  margin-bottom: 0 !important; }
a {
  color: #4183C4; }
a.absent {
  color: #cc0000; }
a.anchor {
  display: block;
  padding-left: 30px;
  margin-left: -30px;
  cursor: pointer;
  position: absolute;
  top: 0;
  left: 0;
  bottom: 0; }
h1, h2, h3, h4, h5, h6 {
  margin: 20px 0 10px;
  padding: 0;
  font-weight: bold;
  -webkit-font-smoothing: antialiased;
  cursor: text;
  position: relative; }
h1:hover a.anchor, h2:hover a.anchor, h3:hover a.anchor, h4:hover a.anchor, h5:hover a.anchor, h6:hover a.anchor {
  background: url("para.png") no-repeat 10px center;
  text-decoration: none; }
h1 tt, h1 code {
  font-size: inherit; }
h2 tt, h2 code {
  font-size: inherit; }
h3 tt, h3 code {
  font-size: inherit; }
h4 tt, h4 code {
  font-size: inherit; }
h5 tt, h5 code {
  font-size: inherit; }
h6 tt, h6 code {
  font-size: inherit; }
h1 {
  font-size: 28px;
  color: black; }
h2 {
  font-size: 24px;
  border-bottom: 1px solid #cccccc;
  color: black; }
h3 {
  font-size: 18px; }
h4 {
  font-size: 16px; }
h5 {
  font-size: 14px; }
h6 {
  color: #777777;
  font-size: 14px; }
p, blockquote, ul, ol, dl, li:first, table, pre {
  margin: 15px 0; }
hr {
  background-color: #e7e7e7;
  border: 0 none;
  height: 4px;
  padding: 0; }
#previewer > h2:first-child {
  margin-top: 0;
  padding-top: 0; }
#previewer > h1:first-child {
  margin-top: 0;
  padding-top: 0; }
  #previewer > h1:first-child + h2 {
    margin-top: 0;
    padding-top: 0; }
#previewer > h3:first-child, #previewer > h4:first-child, #previewer > h5:first-child, #previewer > h6:first-child {
  margin-top: 0;
  padding-top: 0; }
a:first-child h1, a:first-child h2, a:first-child h3, a:first-child h4, a:first-child h5, a:first-child h6 {
  margin-top: 0;
  padding-top: 0; }
h1 p, h2 p, h3 p, h4 p, h5 p, h6 p {
  margin-top: 0; }
li p.first {
  display: inline-block; }
ul, ol {
  padding-left: 30px; }
ul :first-child, ol :first-child {
  margin-top: 0; }
ul :last-child, ol :last-child {
  margin-bottom: 0; }
dl {
  padding: 0; }
  dl dt {
    font-size: 14px;
    font-weight: bold;
    font-style: italic;
    padding: 0;
    margin: 15px 0 5px; }
    dl dt:first-child {
      padding: 0; }
    dl dt > :first-child {
      margin-top: 0; }
    dl dt > :last-child {
      margin-bottom: 0; }
  dl dd {
    margin: 0 0 15px;
    padding: 0 15px; }
    dl dd > :first-child {
      margin-top: 0; }
    dl dd > :last-child {
      margin-bottom: 0; }
blockquote {
  border-left: 4px solid #dddddd;
  padding: 0 15px;
  color: #777777; }
  blockquote > :first-child {
    margin-top: 0; }
  blockquote > :last-child {
    margin-bottom: 0; }
table {
  border-collapse : collapse; 
  padding: 0; }
  table tr {
    border-top: 1px solid #cccccc;
    background-color: white;
    margin: 0;
    padding: 0; }
    table tr:nth-child(2n) {
      background-color: #f8f8f8; }
    table tr th {
      font-weight: bold;
      border: 1px solid #cccccc;
      text-align: left;
      margin: 0;
      padding: 6px 13px; }
    table tr td {
      border: 1px solid #cccccc;
      text-align: left;
      margin: 0;
      padding: 6px 13px; }
    table tr th :first-child, table tr td :first-child {
      margin-top: 0; }
    table tr th :last-child, table tr td :last-child {
      margin-bottom: 0; }
img {
  max-width: 100%; }
span.frame {
  display: block;
  overflow: hidden; }
  span.frame > span {
    border: 1px solid #dddddd;
    display: block;
    float: left;
    overflow: hidden;
    margin: 13px 0 0;
    padding: 7px;
    width: auto; }
  span.frame span img {
    display: block;
    float: left; }
  span.frame span span {
    clear: both;
    color: #333333;
    display: block;
    padding: 5px 0 0; }
span.align-center {
  display: block;
  overflow: hidden;
  clear: both; }
  span.align-center > span {
    display: block;
    overflow: hidden;
    margin: 13px auto 0;
    text-align: center; }
  span.align-center span img {
    margin: 0 auto;
    text-align: center; }
span.align-right {
  display: block;
  overflow: hidden;
  clear: both; }
  span.align-right > span {
    display: block;
    overflow: hidden;
    margin: 13px 0 0;
    text-align: right; }
  span.align-right span img {
    margin: 0;
    text-align: right; }
span.float-left {
  display: block;
  margin-right: 13px;
  overflow: hidden;
  float: left; }
  span.float-left span {
    margin: 13px 0 0; }
span.float-right {
  display: block;
  margin-left: 13px;
  overflow: hidden;
  float: right; }
  span.float-right > span {
    display: block;
    overflow: hidden;
    margin: 13px auto 0;
    text-align: right; }
code, tt {
  margin: 0 2px;
  padding: 0 5px;
  white-space: nowrap;
  border: 1px solid #eaeaea;
  background-color: #f8f8f8;
  border-radius: 3px; }
pre code {
  margin: 0;
  padding: 0;
  white-space: pre;
  border: none;
  background: transparent; }
.highlight pre {
  background-color: #f8f8f8;
  border: 1px solid #cccccc;
  font-size: 13px;
  line-height: 19px;
  overflow: auto;
  padding: 6px 10px;
  border-radius: 3px; }
pre {
  background-color: #f8f8f8;
  border: 1px solid #cccccc;
  font-size: 13px;
  line-height: 19px;
  overflow: auto;
  padding: 6px 10px;
  border-radius: 3px; }
  pre code, pre tt {
    background-color: transparent;
    border: none; }
.sequence, .flow {
  overflow:auto;
}
</style>

<title>無題</title>
</head>
<body>
<nav>
	<span id="messageArea"></span>
	<input type="checkbox" id="autoSyncButton" name="autoSyncButton" checked="checked"><label for="autoSyncButton">自動同期</label>
	<button id="syncButton">同期(F5)</button><button id="toggleButton">編集/閲覧(ESC)</button><button id="saveButton">保存(Ctrl+S)</button>
</nav>
<div id="attach">
	<form id="attachForm"><input type="file" id="attachButton" multiple multiple></form>
	<div id="filer">
		<ul id="fileList">
		</ul>
	</div>
	<button id="attachToggleButton">添付ファイルを表示(Alt+↓)</button><button id="previewToggleButton">プレビューを隠す(Alt+→)</button>
</div>
<div id="wrapper">
	<noscript>このファイルはJavaScriptを有効にしないと閲覧できません。</noscript>
	<textarea id="editor"></textarea>
	<div id="previewer"></div>
</div>
<script>
/**
 * marked - a markdown parser
 * Copyright (c) 2011-2014, Christopher Jeffrey. (MIT Licensed)
 * https://github.com/chjj/marked
 */
(function(){var block={newline:/^\n+/,code:/^( {4}[^\n]+\n*)+/,fences:noop,hr:/^( *[-*_]){3,} *(?:\n+|$)/,heading:/^ *(#{1,6}) *([^\n]+?) *#* *(?:\n+|$)/,nptable:noop,lheading:/^([^\n]+)\n *(=|-){2,} *(?:\n+|$)/,blockquote:/^( *>[^\n]+(\n(?!def)[^\n]+)*\n*)+/,list:/^( *)(bull) [\s\S]+?(?:hr|def|\n{2,}(?! )(?!\1bull )\n*|\s*$)/,html:/^ *(?:comment *(?:\n|\s*$)|closed *(?:\n{2,}|\s*$)|closing *(?:\n{2,}|\s*$))/,def:/^ *\[([^\]]+)\]: *<?([^\s>]+)>?(?: +["(]([^\n]+)[")])? *(?:\n+|$)/,table:noop,paragraph:/^((?:[^\n]+\n?(?!hr|heading|lheading|blockquote|tag|def))+)\n*/,text:/^[^\n]+/};block.bullet=/(?:[*+-]|\d+\.)/;block.item=/^( *)(bull) [^\n]*(?:\n(?!\1bull )[^\n]*)*/;block.item=replace(block.item,"gm")(/bull/g,block.bullet)();block.list=replace(block.list)(/bull/g,block.bullet)("hr","\\n+(?=\\1?(?:[-*_] *){3,}(?:\\n+|$))")("def","\\n+(?="+block.def.source+")")();block.blockquote=replace(block.blockquote)("def",block.def)();block._tag="(?!(?:"+"a|em|strong|small|s|cite|q|dfn|abbr|data|time|code"+"|var|samp|kbd|sub|sup|i|b|u|mark|ruby|rt|rp|bdi|bdo"+"|span|br|wbr|ins|del|img)\\b)\\w+(?!:/|[^\\w\\s@]*@)\\b";block.html=replace(block.html)("comment",/<!--[\s\S]*?-->/)("closed",/<(tag)[\s\S]+?<\/\1>/)("closing",/<tag(?:"[^"]*"|'[^']*'|[^'">])*?>/)(/tag/g,block._tag)();block.paragraph=replace(block.paragraph)("hr",block.hr)("heading",block.heading)("lheading",block.lheading)("blockquote",block.blockquote)("tag","<"+block._tag)("def",block.def)();block.normal=merge({},block);block.gfm=merge({},block.normal,{fences:/^ *(`{3,}|~{3,})[ \.]*(\S+)? *\n([\s\S]*?)\s*\1 *(?:\n+|$)/,paragraph:/^/,heading:/^ *(#{1,6}) +([^\n]+?) *#* *(?:\n+|$)/});block.gfm.paragraph=replace(block.paragraph)("(?!","(?!"+block.gfm.fences.source.replace("\\1","\\2")+"|"+block.list.source.replace("\\1","\\3")+"|")();block.tables=merge({},block.gfm,{nptable:/^ *(\S.*\|.*)\n *([-:]+ *\|[-| :]*)\n((?:.*\|.*(?:\n|$))*)\n*/,table:/^ *\|(.+)\n *\|( *[-:]+[-| :]*)\n((?: *\|.*(?:\n|$))*)\n*/});function Lexer(options){this.tokens=[];this.tokens.links={};this.options=options||marked.defaults;this.rules=block.normal;if(this.options.gfm){if(this.options.tables){this.rules=block.tables}else{this.rules=block.gfm}}}Lexer.rules=block;Lexer.lex=function(src,options){var lexer=new Lexer(options);return lexer.lex(src)};Lexer.prototype.lex=function(src){src=src.replace(/\r\n|\r/g,"\n").replace(/\t/g,"    ").replace(/\u00a0/g," ").replace(/\u2424/g,"\n");return this.token(src,true)};Lexer.prototype.token=function(src,top,bq){var src=src.replace(/^ +$/gm,""),next,loose,cap,bull,b,item,space,i,l;while(src){if(cap=this.rules.newline.exec(src)){src=src.substring(cap[0].length);if(cap[0].length>1){this.tokens.push({type:"space"})}}if(cap=this.rules.code.exec(src)){src=src.substring(cap[0].length);cap=cap[0].replace(/^ {4}/gm,"");this.tokens.push({type:"code",text:!this.options.pedantic?cap.replace(/\n+$/,""):cap});continue}if(cap=this.rules.fences.exec(src)){src=src.substring(cap[0].length);this.tokens.push({type:"code",lang:cap[2],text:cap[3]||""});continue}if(cap=this.rules.heading.exec(src)){src=src.substring(cap[0].length);this.tokens.push({type:"heading",depth:cap[1].length,text:cap[2]});continue}if(top&&(cap=this.rules.nptable.exec(src))){src=src.substring(cap[0].length);item={type:"table",header:cap[1].replace(/^ *| *\| *$/g,"").split(/ *\| */),align:cap[2].replace(/^ *|\| *$/g,"").split(/ *\| */),cells:cap[3].replace(/\n$/,"").split("\n")};for(i=0;i<item.align.length;i++){if(/^ *-+: *$/.test(item.align[i])){item.align[i]="right"}else if(/^ *:-+: *$/.test(item.align[i])){item.align[i]="center"}else if(/^ *:-+ *$/.test(item.align[i])){item.align[i]="left"}else{item.align[i]=null}}for(i=0;i<item.cells.length;i++){item.cells[i]=item.cells[i].split(/ *\| */)}this.tokens.push(item);continue}if(cap=this.rules.lheading.exec(src)){src=src.substring(cap[0].length);this.tokens.push({type:"heading",depth:cap[2]==="="?1:2,text:cap[1]});continue}if(cap=this.rules.hr.exec(src)){src=src.substring(cap[0].length);this.tokens.push({type:"hr"});continue}if(cap=this.rules.blockquote.exec(src)){src=src.substring(cap[0].length);this.tokens.push({type:"blockquote_start"});cap=cap[0].replace(/^ *> ?/gm,"");this.token(cap,top,true);this.tokens.push({type:"blockquote_end"});continue}if(cap=this.rules.list.exec(src)){src=src.substring(cap[0].length);bull=cap[2];this.tokens.push({type:"list_start",ordered:bull.length>1});cap=cap[0].match(this.rules.item);next=false;l=cap.length;i=0;for(;i<l;i++){item=cap[i];space=item.length;item=item.replace(/^ *([*+-]|\d+\.) +/,"");if(~item.indexOf("\n ")){space-=item.length;item=!this.options.pedantic?item.replace(new RegExp("^ {1,"+space+"}","gm"),""):item.replace(/^ {1,4}/gm,"")}if(this.options.smartLists&&i!==l-1){b=block.bullet.exec(cap[i+1])[0];if(bull!==b&&!(bull.length>1&&b.length>1)){src=cap.slice(i+1).join("\n")+src;i=l-1}}loose=next||/\n\n(?!\s*$)/.test(item);if(i!==l-1){next=item.charAt(item.length-1)==="\n";if(!loose)loose=next}this.tokens.push({type:loose?"loose_item_start":"list_item_start"});this.token(item,false,bq);this.tokens.push({type:"list_item_end"})}this.tokens.push({type:"list_end"});continue}if(cap=this.rules.html.exec(src)){src=src.substring(cap[0].length);this.tokens.push({type:this.options.sanitize?"paragraph":"html",pre:!this.options.sanitizer&&(cap[1]==="pre"||cap[1]==="script"||cap[1]==="style"),text:cap[0]});continue}if(!bq&&top&&(cap=this.rules.def.exec(src))){src=src.substring(cap[0].length);this.tokens.links[cap[1].toLowerCase()]={href:cap[2],title:cap[3]};continue}if(top&&(cap=this.rules.table.exec(src))){src=src.substring(cap[0].length);item={type:"table",header:cap[1].replace(/^ *| *\| *$/g,"").split(/ *\| */),align:cap[2].replace(/^ *|\| *$/g,"").split(/ *\| */),cells:cap[3].replace(/(?: *\| *)?\n$/,"").split("\n")};for(i=0;i<item.align.length;i++){if(/^ *-+: *$/.test(item.align[i])){item.align[i]="right"}else if(/^ *:-+: *$/.test(item.align[i])){item.align[i]="center"}else if(/^ *:-+ *$/.test(item.align[i])){item.align[i]="left"}else{item.align[i]=null}}for(i=0;i<item.cells.length;i++){item.cells[i]=item.cells[i].replace(/^ *\| *| *\| *$/g,"").split(/ *\| */)}this.tokens.push(item);continue}if(top&&(cap=this.rules.paragraph.exec(src))){src=src.substring(cap[0].length);this.tokens.push({type:"paragraph",text:cap[1].charAt(cap[1].length-1)==="\n"?cap[1].slice(0,-1):cap[1]});continue}if(cap=this.rules.text.exec(src)){src=src.substring(cap[0].length);this.tokens.push({type:"text",text:cap[0]});continue}if(src){throw new Error("Infinite loop on byte: "+src.charCodeAt(0))}}return this.tokens};var inline={escape:/^\\([\\`*{}\[\]()#+\-.!_>])/,autolink:/^<([^ >]+(@|:\/)[^ >]+)>/,url:noop,tag:/^<!--[\s\S]*?-->|^<\/?\w+(?:"[^"]*"|'[^']*'|[^'">])*?>/,link:/^!?\[(inside)\]\(href\)/,reflink:/^!?\[(inside)\]\s*\[([^\]]*)\]/,nolink:/^!?\[((?:\[[^\]]*\]|[^\[\]])*)\]/,strong:/^__([\s\S]+?)__(?!_)|^\*\*([\s\S]+?)\*\*(?!\*)/,em:/^\b_((?:[^_]|__)+?)_\b|^\*((?:\*\*|[\s\S])+?)\*(?!\*)/,code:/^(`+)\s*([\s\S]*?[^`])\s*\1(?!`)/,br:/^ {2,}\n(?!\s*$)/,del:noop,text:/^[\s\S]+?(?=[\\<!\[_*`]| {2,}\n|$)/};inline._inside=/(?:\[[^\]]*\]|[^\[\]]|\](?=[^\[]*\]))*/;inline._href=/\s*<?([\s\S]*?)>?(?:\s+['"]([\s\S]*?)['"])?\s*/;inline.link=replace(inline.link)("inside",inline._inside)("href",inline._href)();inline.reflink=replace(inline.reflink)("inside",inline._inside)();inline.normal=merge({},inline);inline.pedantic=merge({},inline.normal,{strong:/^__(?=\S)([\s\S]*?\S)__(?!_)|^\*\*(?=\S)([\s\S]*?\S)\*\*(?!\*)/,em:/^_(?=\S)([\s\S]*?\S)_(?!_)|^\*(?=\S)([\s\S]*?\S)\*(?!\*)/});inline.gfm=merge({},inline.normal,{escape:replace(inline.escape)("])","~|])")(),url:/^(https?:\/\/[^\s<]+[^<.,:;"')\]\s])/,del:/^~~(?=\S)([\s\S]*?\S)~~/,text:replace(inline.text)("]|","~]|")("|","|https?://|")()});inline.breaks=merge({},inline.gfm,{br:replace(inline.br)("{2,}","*")(),text:replace(inline.gfm.text)("{2,}","*")()});function InlineLexer(links,options){this.options=options||marked.defaults;this.links=links;this.rules=inline.normal;this.renderer=this.options.renderer||new Renderer;this.renderer.options=this.options;if(!this.links){throw new Error("Tokens array requires a `links` property.")}if(this.options.gfm){if(this.options.breaks){this.rules=inline.breaks}else{this.rules=inline.gfm}}else if(this.options.pedantic){this.rules=inline.pedantic}}InlineLexer.rules=inline;InlineLexer.output=function(src,links,options){var inline=new InlineLexer(links,options);return inline.output(src)};InlineLexer.prototype.output=function(src){var out="",link,text,href,cap;while(src){if(cap=this.rules.escape.exec(src)){src=src.substring(cap[0].length);out+=cap[1];continue}if(cap=this.rules.autolink.exec(src)){src=src.substring(cap[0].length);if(cap[2]==="@"){text=cap[1].charAt(6)===":"?this.mangle(cap[1].substring(7)):this.mangle(cap[1]);href=this.mangle("mailto:")+text}else{text=escape(cap[1]);href=text}out+=this.renderer.link(href,null,text);continue}if(!this.inLink&&(cap=this.rules.url.exec(src))){src=src.substring(cap[0].length);text=escape(cap[1]);href=text;out+=this.renderer.link(href,null,text);continue}if(cap=this.rules.tag.exec(src)){if(!this.inLink&&/^<a /i.test(cap[0])){this.inLink=true}else if(this.inLink&&/^<\/a>/i.test(cap[0])){this.inLink=false}src=src.substring(cap[0].length);out+=this.options.sanitize?this.options.sanitizer?this.options.sanitizer(cap[0]):escape(cap[0]):cap[0];continue}if(cap=this.rules.link.exec(src)){src=src.substring(cap[0].length);this.inLink=true;out+=this.outputLink(cap,{href:cap[2],title:cap[3]});this.inLink=false;continue}if((cap=this.rules.reflink.exec(src))||(cap=this.rules.nolink.exec(src))){src=src.substring(cap[0].length);link=(cap[2]||cap[1]).replace(/\s+/g," ");link=this.links[link.toLowerCase()];if(!link||!link.href){out+=cap[0].charAt(0);src=cap[0].substring(1)+src;continue}this.inLink=true;out+=this.outputLink(cap,link);this.inLink=false;continue}if(cap=this.rules.strong.exec(src)){src=src.substring(cap[0].length);out+=this.renderer.strong(this.output(cap[2]||cap[1]));continue}if(cap=this.rules.em.exec(src)){src=src.substring(cap[0].length);out+=this.renderer.em(this.output(cap[2]||cap[1]));continue}if(cap=this.rules.code.exec(src)){src=src.substring(cap[0].length);out+=this.renderer.codespan(escape(cap[2],true));continue}if(cap=this.rules.br.exec(src)){src=src.substring(cap[0].length);out+=this.renderer.br();continue}if(cap=this.rules.del.exec(src)){src=src.substring(cap[0].length);out+=this.renderer.del(this.output(cap[1]));continue}if(cap=this.rules.text.exec(src)){src=src.substring(cap[0].length);out+=this.renderer.text(escape(this.smartypants(cap[0])));continue}if(src){throw new Error("Infinite loop on byte: "+src.charCodeAt(0))}}return out};InlineLexer.prototype.outputLink=function(cap,link){var href=escape(link.href),title=link.title?escape(link.title):null;return cap[0].charAt(0)!=="!"?this.renderer.link(href,title,this.output(cap[1])):this.renderer.image(href,title,escape(cap[1]))};InlineLexer.prototype.smartypants=function(text){if(!this.options.smartypants)return text;return text.replace(/---/g,"—").replace(/--/g,"–").replace(/(^|[-\u2014/(\[{"\s])'/g,"$1‘").replace(/'/g,"’").replace(/(^|[-\u2014/(\[{\u2018\s])"/g,"$1“").replace(/"/g,"”").replace(/\.{3}/g,"…")};InlineLexer.prototype.mangle=function(text){if(!this.options.mangle)return text;var out="",l=text.length,i=0,ch;for(;i<l;i++){ch=text.charCodeAt(i);if(Math.random()>.5){ch="x"+ch.toString(16)}out+="&#"+ch+";"}return out};function Renderer(options){this.options=options||{}}Renderer.prototype.code=function(code,lang,escaped){if(this.options.highlight){var out=this.options.highlight(code,lang);if(out!=null&&out!==code){escaped=true;code=out}}if(!lang){return"<pre><code>"+(escaped?code:escape(code,true))+"\n</code></pre>"}return'<pre><code class="'+this.options.langPrefix+escape(lang,true)+'">'+(escaped?code:escape(code,true))+"\n</code></pre>\n"};Renderer.prototype.blockquote=function(quote){return"<blockquote>\n"+quote+"</blockquote>\n"};Renderer.prototype.html=function(html){return html};Renderer.prototype.heading=function(text,level,raw){return"<h"+level+' id="'+this.options.headerPrefix+raw.toLowerCase().replace(/[^\w]+/g,"-")+'">'+text+"</h"+level+">\n"};Renderer.prototype.hr=function(){return this.options.xhtml?"<hr/>\n":"<hr>\n"};Renderer.prototype.list=function(body,ordered){var type=ordered?"ol":"ul";return"<"+type+">\n"+body+"</"+type+">\n"};Renderer.prototype.listitem=function(text){return"<li>"+text+"</li>\n"};Renderer.prototype.paragraph=function(text){return"<p>"+text+"</p>\n"};Renderer.prototype.table=function(header,body){return"<table>\n"+"<thead>\n"+header+"</thead>\n"+"<tbody>\n"+body+"</tbody>\n"+"</table>\n"};Renderer.prototype.tablerow=function(content){return"<tr>\n"+content+"</tr>\n"};Renderer.prototype.tablecell=function(content,flags){var type=flags.header?"th":"td";var tag=flags.align?"<"+type+' style="text-align:'+flags.align+'">':"<"+type+">";return tag+content+"</"+type+">\n"};Renderer.prototype.strong=function(text){return"<strong>"+text+"</strong>"};Renderer.prototype.em=function(text){return"<em>"+text+"</em>"};Renderer.prototype.codespan=function(text){return"<code>"+text+"</code>"};Renderer.prototype.br=function(){return this.options.xhtml?"<br/>":"<br>"};Renderer.prototype.del=function(text){return"<del>"+text+"</del>"};Renderer.prototype.link=function(href,title,text){if(this.options.sanitize){try{var prot=decodeURIComponent(unescape(href)).replace(/[^\w:]/g,"").toLowerCase()}catch(e){return""}if(prot.indexOf("javascript:")===0||prot.indexOf("vbscript:")===0){return""}}var out='<a href="'+href+'"';if(title){out+=' title="'+title+'"'}out+=">"+text+"</a>";return out};Renderer.prototype.image=function(href,title,text){var out='<img src="'+href+'" alt="'+text+'"';if(title){out+=' title="'+title+'"'}out+=this.options.xhtml?"/>":">";return out};Renderer.prototype.text=function(text){return text};function Parser(options){this.tokens=[];this.token=null;this.options=options||marked.defaults;this.options.renderer=this.options.renderer||new Renderer;this.renderer=this.options.renderer;this.renderer.options=this.options}Parser.parse=function(src,options,renderer){var parser=new Parser(options,renderer);return parser.parse(src)};Parser.prototype.parse=function(src){this.inline=new InlineLexer(src.links,this.options,this.renderer);this.tokens=src.reverse();var out="";while(this.next()){out+=this.tok()}return out};Parser.prototype.next=function(){return this.token=this.tokens.pop()};Parser.prototype.peek=function(){return this.tokens[this.tokens.length-1]||0};Parser.prototype.parseText=function(){var body=this.token.text;while(this.peek().type==="text"){body+="\n"+this.next().text}return this.inline.output(body)};Parser.prototype.tok=function(){switch(this.token.type){case"space":{return""}case"hr":{return this.renderer.hr()}case"heading":{return this.renderer.heading(this.inline.output(this.token.text),this.token.depth,this.token.text)}case"code":{return this.renderer.code(this.token.text,this.token.lang,this.token.escaped)}case"table":{var header="",body="",i,row,cell,flags,j;cell="";for(i=0;i<this.token.header.length;i++){flags={header:true,align:this.token.align[i]};cell+=this.renderer.tablecell(this.inline.output(this.token.header[i]),{header:true,align:this.token.align[i]})}header+=this.renderer.tablerow(cell);for(i=0;i<this.token.cells.length;i++){row=this.token.cells[i];cell="";for(j=0;j<row.length;j++){cell+=this.renderer.tablecell(this.inline.output(row[j]),{header:false,align:this.token.align[j]})}body+=this.renderer.tablerow(cell)}return this.renderer.table(header,body)}case"blockquote_start":{var body="";while(this.next().type!=="blockquote_end"){body+=this.tok()}return this.renderer.blockquote(body)}case"list_start":{var body="",ordered=this.token.ordered;while(this.next().type!=="list_end"){body+=this.tok()}return this.renderer.list(body,ordered)}case"list_item_start":{var body="";while(this.next().type!=="list_item_end"){body+=this.token.type==="text"?this.parseText():this.tok()}return this.renderer.listitem(body)}case"loose_item_start":{var body="";while(this.next().type!=="list_item_end"){body+=this.tok()}return this.renderer.listitem(body)}case"html":{var html=!this.token.pre&&!this.options.pedantic?this.inline.output(this.token.text):this.token.text;return this.renderer.html(html)}case"paragraph":{return this.renderer.paragraph(this.inline.output(this.token.text))}case"text":{return this.renderer.paragraph(this.parseText())}}};function escape(html,encode){return html.replace(!encode?/&(?!#?\w+;)/g:/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function unescape(html){return html.replace(/&([#\w]+);/g,function(_,n){n=n.toLowerCase();if(n==="colon")return":";if(n.charAt(0)==="#"){return n.charAt(1)==="x"?String.fromCharCode(parseInt(n.substring(2),16)):String.fromCharCode(+n.substring(1))}return""})}function replace(regex,opt){regex=regex.source;opt=opt||"";return function self(name,val){if(!name)return new RegExp(regex,opt);val=val.source||val;val=val.replace(/(^|[^\[])\^/g,"$1");regex=regex.replace(name,val);return self}}function noop(){}noop.exec=noop;function merge(obj){var i=1,target,key;for(;i<arguments.length;i++){target=arguments[i];for(key in target){if(Object.prototype.hasOwnProperty.call(target,key)){obj[key]=target[key]}}}return obj}function marked(src,opt,callback){if(callback||typeof opt==="function"){if(!callback){callback=opt;opt=null}opt=merge({},marked.defaults,opt||{});var highlight=opt.highlight,tokens,pending,i=0;try{tokens=Lexer.lex(src,opt)}catch(e){return callback(e)}pending=tokens.length;var done=function(err){if(err){opt.highlight=highlight;return callback(err)}var out;try{out=Parser.parse(tokens,opt)}catch(e){err=e}opt.highlight=highlight;return err?callback(err):callback(null,out)};if(!highlight||highlight.length<3){return done()}delete opt.highlight;if(!pending)return done();for(;i<tokens.length;i++){(function(token){if(token.type!=="code"){return--pending||done()}return highlight(token.text,token.lang,function(err,code){if(err)return done(err);if(code==null||code===token.text){return--pending||done()}token.text=code;token.escaped=true;--pending||done()})})(tokens[i])}return}try{if(opt)opt=merge({},marked.defaults,opt);return Parser.parse(Lexer.lex(src,opt),opt)}catch(e){e.message+="\nPlease report this to https://github.com/chjj/marked.";if((opt||marked.defaults).silent){return"<p>An error occured:</p><pre>"+escape(e.message+"",true)+"</pre>"}throw e}}marked.options=marked.setOptions=function(opt){merge(marked.defaults,opt);return marked};marked.defaults={gfm:true,tables:true,breaks:false,pedantic:false,sanitize:false,sanitizer:null,mangle:true,smartLists:false,silent:false,highlight:null,langPrefix:"lang-",smartypants:false,headerPrefix:"",renderer:new Renderer,xhtml:false};marked.Parser=Parser;marked.parser=Parser.parse;marked.Renderer=Renderer;marked.Lexer=Lexer;marked.lexer=Lexer.lex;marked.InlineLexer=InlineLexer;marked.inlineLexer=InlineLexer.output;marked.parse=marked;if(typeof module!=="undefined"&&typeof exports==="object"){module.exports=marked}else if(typeof define==="function"&&define.amd){define(function(){return marked})}else{this.marked=marked}}).call(function(){return this||(typeof window!=="undefined"?window:global)}());
</script>
<script>
function toKantanEditor(editor) {
	/* tabキーでtabを入力 */
	editor.addEventListener('keydown', function(e) {
		if ((e.which != 9) && (e.keyCode != 9)) {
			return true;
		}
		e.preventDefault();
		
		var start = editor.selectionStart;
		var end   = editor.selectionEnd;
		if (start == end) {
			/* いわゆる普通のtab */
			
			var text = editor.value;
			editor.value = text.substr(0, start) + '\t' + text.substr(start, text.length);
			editor.setSelectionRange(start + 1, start + 1);
			updateScrollPos(e.target);
			saveUndo(e.target);
		} else {
			if (e.shiftKey) {
				/* 選択 + Shift + Tabで複数行アウトデント */
				var style = editor.currentStyle 
						|| document.defaultView.getComputedStyle(editor, '');
				var tabSize = style.tabSize
							|| style.MozTabSize
							|| 8;
				tabSize = Number(tabSize);
				
				// スタート・エンド位置特定
				var orgText = editor.value;
				while ((0 < start) && (orgText.charAt(start - 1) != "\n")) {
					start--;
				}
				if (orgText.charAt(end - 1) == "\n") {
					end -= 1;
				}
				while ((end < orgText.length) && (orgText.charAt(end) != "\n")) {
					end++;
				}
				end--;
				
				var deleteCount = 0;
				var newText = orgText.substring(0, start);
				var i = start;
				while (i < end) {
					var c = orgText.charAt(i);
					var spaceCount = 0;
					while (spaceCount < tabSize) {
						if (c == " ") {
							spaceCount += 1;
							deleteCount++;
						} else if (c == " ") {
							spaceCount += 2;
							deleteCount++;
						} else if (c == "\t") {
							spaceCount += tabSize;
							deleteCount++;
						} else {
							newText += c;
							i++;
							break;
						}
						c = orgText.charAt(++i);
					}
					while ((c != "\n") && (i < end)) {
						c = orgText.charAt(i++);
						newText += c;
					} 
				}
				newText += orgText.substr(end)
				
				editor.value = newText;
				
				editor.selectionStart = start;
				editor.selectionEnd   = end - deleteCount + 1;
				updateScrollPos(e.target);
				saveUndo(e.target);
			} else {
				/* 選択 + Tabで複数行インデント */
				
				// スタート・エンド位置特定
				var orgText = editor.value;
				while ((0 < start) && (orgText.charAt(start - 1) != "\n")) {
					start--;
				}
				if (orgText.charAt(end - 1) == "\n") {
					end -= 1;
				}
				while ((end < orgText.length) && (orgText.charAt(end) != "\n")) {
					end++;
				}
				
				// タブ挿入
				var count = 1;
				var newText = orgText.substring(0, start) + "\t";
				for (var i = start; i < end; i++) {
					var c = orgText.charAt(i);
					newText += c;
					if (c == "\n") {
						newText += "\t";
						count++;
					}
				}
				newText += orgText.substr(end);
				
				// テキスト入れ替え
				editor.value = newText;
				
				// 選択位置修正
				editor.selectionStart = start;
				editor.selectionEnd   = end + count;
				updateScrollPos(e.target);
				saveUndo(e.target);
			}
		}
		
		return false;
	});
	
	/* オートインデント */
	editor.addEventListener('keydown', function(e) {
		
		// Enterキー
		if (e.which == 13 || e.keyCode == 13) {
			e.preventDefault();
			
			// 行頭か先頭に至るまでさかのぼる
			var count = 0;
			var text = editor.value;
			var pos = editor.selectionStart;
			while ((0 < pos) && (text.charAt(pos - 1) != "\n")) {
				pos--;
				count++;
			}
			
			// 先頭の空白文字を記憶
			var spaces = "";
			for (var i = 0; i < count; i++) {
				var c = text.charAt(pos + i);
				if((c != " ") && (c !=  "　") && (c != "\t")) {
					break;
				}
				spaces += c;
			}			
			
			// 改行＋スペース（タブ）の挿入
			var newPos = editor.selectionStart + spaces.length + 1;
			var part1 = text.substring(0, editor.selectionStart);
			var part2 = text.substr(editor.selectionEnd);
			editor.value = part1 + "\n" + spaces + part2;
			
			editor.selectionStart = newPos;
			editor.selectionEnd = newPos;
			updateScrollPos(e.target);
			
			saveUndo(e.target);
		}
	});

	/* Undo, Redo */
	var isCtrlVDowning = false;
	var keyCache = {};
	var undoStack = [];
	var redoStack = [];
	var previousVal = {val:editor.value, selectionStart:undefined, selectionEnd:undefined};
	var valueAtArrowOrClick = undefined;
	editor.addEventListener("keydown", function(e){
		if (e.code == "Enter") {
			saveUndo(e.target);
		} else if ((e.which == 86 || e.keyCode == 86) && (e.ctrlKey || e.metaKey) && !isCtrlVDowning) {
			// Ctrl + vの前にundoできるようにする
			saveUndoAfterPaste(e.target);
			isCtrlVDowning = true;
		} else if ((e.which == 86 || e.keyCode == 86) && (e.ctrlKey || e.metaKey) && isCtrlVDowning) {
			// Ctrl + vを押しっぱなしの時は普通のundo(#73 fix)
			saveUndo(e.target);
		} 
		var code = (e.keyCode ? e.keyCode : e.which);
		if ((37 <= code) && (code <= 40)) {
			keyCache[e.code] = true;
		}
	});
	editor.addEventListener("keypress", function(e){
		keyCache[e.code] = true;
	});
	editor.addEventListener("keyup", function(e){
		if ((e.which == 13 || e.keyCode == 13)                          // ENTER
				|| (e.which == 8 || e.keyCode == 8)                      // BS
				|| (e.which == 46 || e.keyCode == 46)                    // DELETE
				|| ((e.which == 86 || e.keyCode == 86) && (e.ctrlKey || e.metaKey))     // Ctrl+v
				|| ((e.which == 88 || e.keyCode == 88) && (e.ctrlKey || e.metaKey))) {  //Ctrl+x
			
			saveUndo(e.target);
		} else if (keyCache[e.code] == true) {
			var code = (e.keyCode ? e.keyCode : e.which);
			if ((37 <= code) && (code <= 40)) {
				valueAtArrowOrClick = {
					val: editor.value,
					selectionStart: editor.selectionStart,
					selectionEnd: editor.selectionEnd
				};
				keyCache[e.code] = false;
			} else {
				// keypressが発生していた(IME OFF)なら、Undo可能にする
				keyCache[e.code] = false;
				saveUndo(e.target);
			}
		}
		// Ctrl+Vを離したらフラグを下げる
		if (!e.ctrlKey && !e.metaKey && isCtrlVDowning) {
			isCtrlVDowning = false;
		}
	});
	editor.addEventListener("mouseup", function(e) {
		valueAtArrowOrClick = {
			val: editor.value,
			selectionStart: editor.selectionStart,
			selectionEnd: editor.selectionEnd
		};
	});
	
	editor.addEventListener("keydown", function(e) {
		// Ctrl+Z
		if (e.keyCode == 90 && (e.ctrlKey || e.metaKey) && !e.shiftKey) {
			e.preventDefault();
			
			if (0 < undoStack.length) {
				redoStack.push(previousVal);
				
				var undo = undoStack.pop();
				editor.value = undo.val;
				editor.selectionStart = undo.selectionStart;
				editor.selectionEnd   = undo.selectionEnd;
				updateScrollPos(e.target);
				previousVal = undo;
				
				if (undoStack.length == 0) {
					var event = new CustomEvent("undoStackEmpty");
					editor.dispatchEvent(event);
				}
			}
		}
	});
	
	editor.addEventListener("keydown", function(e) {
		// Ctrl+Y or Ctrl + Shift + Z or Cmd + Shift + Z
		if ((e.keyCode == 89 && (e.ctrlKey || e.metaKey))
				|| (e.keyCode == 90 && e.ctrlKey && e.shiftKey)
				|| (e.keyCode == 90 && e.metaKey && e.shiftKey)) {
			e.preventDefault();
			
			if (0 < redoStack.length) {
				undoStack.push(previousVal);
				previousVal = redoStack.pop();
				editor.value = previousVal.val;
				editor.selectionStart = previousVal.selectionStart;
				editor.selectionEnd   = previousVal.selectionEnd;
				updateScrollPos(e.target);
			}
		}
	});
	
	var saveUndo = function(editor) {
		if (previousVal.val != editor.value) {
			if(valueAtArrowOrClick) {
				undoStack.push(valueAtArrowOrClick);
				valueAtArrowOrClick = undefined;
			} else {
				undoStack.push(previousVal);
			}
			
			redoStack = [];
			previousVal = {
				val: editor.value,
				selectionStart: editor.selectionStart,
				selectionEnd  : editor.selectionEnd
			}
		}
	}
	
	var saveUndoAfterPaste = function(editor) {
		redoStack = [];
		previousVal = {
			val: editor.value,
			selectionStart: editor.selectionStart,
			selectionEnd  : editor.selectionEnd
		}
	}
	/* 共通関数 */
	
	// スクロールバー位置更新
	// chromeやIEではjsで値を変更してキャレットが画面の外に出ても
	// スクロールバーが追従しないのを何とかする関数
	var updateScrollPos = function(editor) {
		// 初期状態を保存
		var text = editor.value;
		var selectionStart = editor.selectionStart;
		var selectionEnd   = editor.selectionEnd;
	
		// insertTextコマンドで適当な文字(X)の追加を試みる
		var isInsertEnabled;
		try {
			isInsertEnabled = document.execCommand("insertText", false, "X");
		} catch(e) {
			// IE10では何故かfalseを返さずに例外が発生するのでcatchで対応する
			isInsertEnabled = false;
		}
		
		if (isInsertEnabled) {
			// insertTextに成功したらChrome
			// chromeはどう頑張ってもまっとうな手段が通用しない。
			// 苦肉の策としてselectionStart,endを揃えてから
			// 一旦フォーカスを外してすぐに戻す。そうするとスクロールバーが追従する
			// これにより、chromeではblurやfocusイベントはまともに使えなくなる黒魔術
			editor.value = text;
			editor.selectionStart = selectionStart;
			editor.selectionEnd = selectionStart;
			editor.blur();
			editor.focus();
			
			// valは戻してあるのでキャレット位置のみ元に戻す
			editor.selectionStart = selectionStart;
			editor.selectionEnd = selectionEnd;
		} else {
			// IE,FirefoxはinsertTextに失敗するのでval関数で適当な文字(X)を挿入する。
			// IEではその後にその文字を選択してdeleteコマンドで削除するとスクロールバーが追従する
			var part1 = text.substring(0, selectionStart);
			var part2 = text.substr(selectionEnd);
			editor.value = part1 + "X" + part2;
			editor.selectionStart = part1.length;
			editor.selectionEnd = part1.length + 1;
			var isDeleteEnabled = document.execCommand("delete", false, null);
			
			// 追従した後はvalとキャレットを元に戻す
			editor.value = text;
			editor.selectionStart = selectionStart;
			editor.selectionEnd = selectionEnd;
		}
	}
}
</script>
<script>
/* 編集不可ブラウザ判定 */

// Blobが使用できないブラウザは保存不可(IE9等)
try {
	new Blob(["temp"]);
} catch(e) {
	setViewMode(); 
}

// Safariはdownload属性に対応していないので閲覧のみ
var ua = window.navigator.userAgent.toLowerCase();
if ((ua.indexOf("chrome") == -1) && (ua.indexOf('safari') != -1)) {
	setViewMode();
}

function setViewMode() {
	document.getElementById("messageArea").innerText
			 = "このブラウザでは編集できません。";
	var navElems = document.querySelectorAll("nav > *");
	for (var i = 0; i < navElems.length; i++) {
		navElems[i].setAttribute("disabled", "disabled");
	}
}

/* エディタに機能追加 */
toKantanEditor(document.getElementById("editor"));

/* 起動時にコンテンツ読み込み */
if (document.getElementById("editor").innerHTML == "") {
	// 内容が空であれば初期状態を編集モードにする
	toggleMode();
} else {
	doPreview();
}

/* レイアウト調整 */
doLayout();
window.addEventListener("resize", doLayout);
function doLayout() {
	var editor = document.getElementById("editor");
	var previewer = document.getElementById("previewer");
	var wrapper = document.getElementById("wrapper");
	
	var height = window.innerHeight - wrapper.offsetTop - 10;
	wrapper.style.height = height + "px";
	
	if (isVisible(editor)) {
		previewer.style.width = "50%";
		previewer.style.height = "100%";
	} else {
		previewer.style.width = "980px";
		previewer.style.height = "";
	}
}

/* 編集・閲覧切り替え */
var editorScrollBarPos = 0;
var previewerScrollBarPos = 0;
var caretStartPos = 0;
var caretEndPos = 0;
document.getElementById("toggleButton").addEventListener("click", toggleMode);

function toggleMode() {
	var attach = document.getElementById("attach");
	var editor = document.getElementById("editor");
	var previewer = document.getElementById("previewer");
	if (isVisible(editor)) {
		editorScrollBarPos    = editor.scrollTop;
		previewerScrollBarPos = previewer.scrollTop;
		caretStartPos = editor.selectionStart;
		caretEndPos = editor.selectionEnd;
	}

	//プレビュー領域を必ず表示
	if (!isVisible(previewer)) {
		openPreview();
	}
	
	if (isVisible(editor)) {
		hide(attach);
		hide(editor);
	} else {
		showBlock(attach);
		showBlock(editor);
	}
	
	doPreview();
	doLayout();
	
	if (isVisible(editor)) {
		editor.scrollTop    = editorScrollBarPos;
		previewer.scrollTop = previewerScrollBarPos;
		editor.selectionStart = caretStartPos;
		editor.selectionEnd = caretEndPos;
		editor.focus();
	}
}

/* エディタとプレビューの同期 */

// 自動同期チェックボックスをクリックしたらchecked属性を更新する
// これを行わないと自動同期チェックボックスの状態が保存されない
document.getElementById("autoSyncButton").addEventListener("change", function() {
	if (this.checked == true) {
		this.setAttribute("checked", "checked");
	} else {
		this.removeAttribute("checked");
	}
});

//更新ボタンを押したら更新する 
document.getElementById("syncButton").addEventListener("click", doPreview);

// エディタに変化があったらプレビュー予約
document.getElementById("editor").addEventListener("change", queuePreview);
document.getElementById("editor").addEventListener("keyup", queuePreview);

// 自動更新がONならプレビューする
// ただし、onkeyupなど呼ばれる頻度が高いので一定時間待って最後の呼び出しのみ実行する
var queue = null, // キューをストック 
wait = 300; // 0.3秒後に実行の場合 
function queuePreview() {
	var autoSyncButton = document.getElementById("autoSyncButton");
	if (!autoSyncButton.checked) {
		return;
	}

	// イベント発生の都度、キューをキャンセル 
	clearTimeout( queue );
	 
	// waitで指定したミリ秒後に所定の処理を実行 
	// 経過前に再度イベントが発生した場合
	// キューをキャンセルして再カウント 
	queue = setTimeout(doPreview, wait);
}


// 同期実行
function doPreview() {	
	// スクロールバー下端判定
	var scrollLockFlag = isMaxScroll("previewer");
	
	// マークダウンレンダリング
	var previewer = document.getElementById("previewer");
	previewer.innerHTML = marked(editor.value);
	
	// タイトル変更
	var h1 = document.querySelector("h1");
	if(h1) {
		document.title = h1.innerText;
	} else {
		document.title = "無題";
	}
	if (saved == false) {
		document.title = "* " + document.title;
	}
	
	
	// 画像埋め込み
	var images = document.getElementsByTagName("img");
	for (i in images) {
		var elem = images[i];
		var img = document.getElementById("attach-" + elem.name);
		if (img != null) {
			elem.src = img.innerHTML;
		}
	}
	
	// スクロールバーが最下部にある場合、更新後も最下部にする。
	if (scrollLockFlag == true) {
		previewer.scrollTop = previewer.scrollHeight;
	}
}

function isMaxScroll (id) {
	var elem = document.getElementById(id);
	
	var scrollHeight = elem.scrollHeight;
	var clientHeight = elem.clientHeight;
	var scrollTop = elem.scrollTop;
	var diff = scrollHeight - (clientHeight + scrollTop)
	
	// 小数点付きの計算なので数ピクセルの誤差を許容する
	return (-1.0 <= diff) && (diff <= 1.0);
}

/* ファイル添付 */
document.getElementById("attachButton").addEventListener("change", function(e) {
	var elem = e.target;
    var files = elem.files;
    attachFiles(files);
});
document.getElementsByTagName("body")[0].addEventListener("dragover", function(e) {
	e.stopPropagation();
	e.preventDefault();
	e.dataTransfer.dropEffect = 'copy';
	this.classList.add('onDragover');
});
document.getElementsByTagName("body")[0].addEventListener("drop", function(e) {
	e.stopPropagation();
	e.preventDefault();
	attachFiles(e.dataTransfer.files);
	this.classList.remove("onDragover");
	
	// ファイルドロップ時にfilerが閉じていたら開く
	if (0 < e.dataTransfer.files.length) {
		var editor = document.getElementById("editor");
		var toggleButton = document.getElementById("toggleButton");
		var filer = document.getElementById("filer");
		if (!isVisible(editor)) {
			toggleButton.click();
		}
		if (!isVisible(filer)) {
			openFiler();
		}
	}
});
document.getElementsByTagName("body")[0].addEventListener("dragleave", function(e){
	this.classList.remove("onDragover");
});

function attachFiles(files){
    for (var i = 0; i < files.length; i++) {
	    var fr = new FileReader();
	    
	    fr.onload = function(e) {
	    	var target = e.target;
	    	var name = target.fileName;
	    	
	    	var li = document.createElement("li");
	    	
	    	var script = document.createElement("script");
	    	script.type  = "text/template";
	    	script.id    = "attach-" + name;
	    	script.title = name;
	    	script.innerHTML = target.result;
	    	li.appendChild(script);
	    	
	    	var input  = document.createElement("input");
	    	input.type = "text";
	    	input.classList.add('fileName');
	    	input.value = name;
	    	input.addEventListener("change", onFileNameChanged);
	    	li.appendChild(input);
	    	
	    	var detachButton = document.createElement("button");
	    	detachButton.classList.add('detachButton');
	    	detachButton.innerHTML = "×";
	    	detachButton.addEventListener("click", onDetachButtonClicked);
	    	li.appendChild(detachButton);
	    	
	    	document.getElementById("fileList").appendChild(li);
	    	
	    	queuePreview();
		}
		
		fr.fileName = files[i].name;
	    fr.readAsDataURL(files[i]);
	}
}

/* ファイル削除 */
var onDetachButtonClicked = function(e) {
	// 削除ボタンが押されたら親要素(li)ごと削除
	if(window.confirm('削除していいですか?')){
		var parent = e.target.parentNode;
		parent.parentNode.removeChild(parent);
		saved = false;
	}
}

/* ファイル名変更 */
var fileNameElems = document.getElementsByClassName("fileName");
for (var i = 0; i < fileNameElems.length; i++) {
	// なぜかvale属性の変更が保存されないので起動時に引っ張ってきてやる
	var fileNameElem = fileNameElems[i];
	var fileName = fileNameElem.previousElementSibling.getAttribute("title");
	fileNameElem.value = fileName;
}

var onFileNameChanged = function(e) {
	var target = e.target;
	if (target.value.trim() == "") {
		alert("名前は必ず入力してください");
		target.focus();
	} else {
		var scriptTag = target.previousElementSibling;
		scriptTag.id =  "attach-" + target.value;
		scriptTag.title = target.value;
		saved = false;
		queuePreview();
	}
}

/* 添付ファイル領域開け閉め */
document.getElementById("attachToggleButton")
		.addEventListener("click", function() {
	if (isVisible(document.getElementById("filer"))){
		closeFiler();
	} else {
		openFiler();
	}
});

/* プレビュー領域開け閉め */
document.getElementById("previewToggleButton")
		.addEventListener("click", function() {
	if (isVisible(document.getElementById("previewer"))){
		closePreview();
	} else {
		openPreview();
	}
});

function openFiler() {
	document.getElementById("attachToggleButton").innerText = "添付ファイルを隠す(Alt+↑)";
	showBlock(document.getElementById("attachForm"));
	showBlock(document.getElementById("filer"));
	doLayout();
}

function closeFiler() {
	document.getElementById("attachToggleButton").innerText = "添付ファイルを表示(Alt+↓)";
	hide(document.getElementById("attachForm"));
	hide(document.getElementById("filer"));
	doLayout();
}

function openPreview() {
	// エディタサイズに相対値を利用しているためプレビュー表示されていない場合のみ実行
	// 閲覧モード時は実行しない
	var editor = document.getElementById("editor");
	var previewer = document.getElementById("previewer");
	if (isVisible(editor) && !isVisible(previewer)) {
		document.getElementById("previewToggleButton").innerText = "プレビューを隠す(Alt+→)";
		editor.style.width = "50%";
		showBlock(previewer);
		doLayout();
	}
}

function closePreview() {
	// エディタサイズに相対値を利用しているためプレビュー表示されている場合のみ実行
	// 閲覧モード時は実行しない
	var editor = document.getElementById("editor");
	var previewer = document.getElementById("previewer");
	if (isVisible(editor) && isVisible(previewer)) {
		document.getElementById("previewToggleButton").innerText = "プレビューを表示(Alt+←)";
		editor.style.width = "100%";
		hide(previewer);
		doLayout();
	}
}

/* 保存 */
document.getElementById("saveButton").addEventListener("click", save);

function save() {
	// テキストエリアは値を入れなおさないと保存されない。
	var editor = document.getElementById("editor");
	editor.innerHTML = editor.value.replace(/</g, "&lt;");
	
	var toggleFlag = isEnable(editor);
	if (toggleFlag == true) {
		toggleMode();
	}
	
	/* ファイルの肥大化を防ぐため中身を消去 */
	document.getElementById("previewer").innerHTML = "";
	document.getElementById("messageArea").innerHTML = "";
	
	var html = "<!doctype html>\n<html>\n";
	html += document.getElementsByTagName("html")[0].innerHTML;
	var i = html.lastIndexOf("/script>"); // bug fix #1 #39
	html = html.substring(0, i);
	html += "/script>\n</body>\n</html>";

	var blob = new Blob([html]);
	if (window.navigator.msSaveBlob) {
		/* for IE */
		window.navigator.msSaveBlob(blob, document.title + ".html");
	} else {
		var url = window.URL || window.webkitURL;		
		var blobURL = url.createObjectURL(blob);
		var a = document.createElement('a');
		a.download = document.title.replace(/^\* /, "") + ".html";
		a.href = blobURL;
		
		// firefoxでa.click()が効かないため無理やりclickイベントをディスパッチする
		var ev = document.createEvent("MouseEvents");
	    ev.initMouseEvent("click", true, false, self, 0, 0, 0, 0, 0, false, false, false, false, 0, null);
		a.dispatchEvent(ev);
		delete a;
	}
	saved = true;
	doPreview();
	if (toggleFlag == true) {
		toggleMode();
	}
}

/* 更新時、終了時の警告 */
var saved = true;
window.onbeforeunload = function() {
	if (!saved) {
		return "ドキュメントが保存されていません。"
	}
}

document.getElementById("editor").addEventListener("input", function(e) {
	if (saved == true) {
		saved = false;
	}
});
document.getElementById("editor").addEventListener("undoStackEmpty", function(e){
	saved = true;
});

/* ショートカットキー */
window.addEventListener("keydown", function(event) {
	var code = (event.keyCode ? event.keyCode : event.which);
	
	if (code == 27) {
		// ESCキーで閲覧/編集モード切り替え
		event.preventDefault();
		
		var toggleButton = document.getElementById("toggleButton");
		if (isEnable(toggleButton)) {
			toggleButton.click();
		}
		return false;
	}
	
	
	if (code == 83 && (event.ctrlKey || event.metaKey)){
		// CTRL+Sで保存する
		event.preventDefault();
		
		var saveButton = document.getElementById("saveButton");
		if (isEnable(saveButton)) {
			saveButton.click();
		}
		return false;
	}
	
	if (code == 116 ||
			((code == 82) && (event.ctrlKey || event.metaKey))){
		// F5 or Ctrl + Rでエディタとプレビューアを同期
		event.preventDefault();
		
		var syncButton = document.getElementById("syncButton");
		if (isEnable(syncButton)) {
			doPreview();
		}
		return false;
	}

	if ((code == 37) && event.altKey) {
		// Alt+←
		event.preventDefault();
		openPreview();
		return false;
	}

	if ((code == 38) && event.altKey) {
		// Alt+↑
		event.preventDefault();
		closeFiler();
		return false;
	}

	if ((code == 39) && event.altKey) {
		// Alt+→
		event.preventDefault();
		closePreview();
		return false;
	}
	
	if ((code == 40) && event.altKey) {
		// Alt+↓
		event.preventDefault();
		openFiler();
		return false;
	}
	
	return true;
});

function isEnable(elem) {
	return elem &&
			((typeof elem.disabled === "undefined")
			|| (elem.disabled == false));
}

function isVisible(elem) {
	var style = elem.currentStyle || document.defaultView.getComputedStyle(elem, '');
	if (style.display == "none") {
		return false;
	}
	var parent = (elem.tagName.toLowerCase() == "body") ? null : elem.parentNode;
	if (!parent) {
		return true;
	} else {
		return isVisible(parent);
	}
}

function showBlock(elem) {
	elem.style.display = "block";
}

function hide(elem) {
	elem.style.display = "none";
}
</script>
</body>
</html>
